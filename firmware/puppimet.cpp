#include "puppimet.h"
#include "lut.h"
#include <hls_math.h>
// #include <hls_stream.h>
#include <cassert>
#ifndef __SYNTHESIS__
#include <cstdio>
#include <ap_int.h>
#include <ap_fixed.h>
#endif


void Get_LUT(phi_t in_phi, LUT_tri_T &out_sin, LUT_tri_T &out_cos){

    int sin_index = 0;
    int cos_index = 0;

    if (in_phi <= -360)      sin_index = in_phi + 720;
    else if (in_phi < 0)     sin_index = -in_phi;
    else if (in_phi <= 360)  sin_index = in_phi;
    else                  sin_index = 720 - in_phi;
    
    if (in_phi <= -360)      cos_index = in_phi + 720;
    else if (in_phi < 0)     cos_index = -in_phi;
    else if (in_phi <= 360)  cos_index = in_phi;
    else                  cos_index = 720 - in_phi;
    

    LUT_tri_T sin_mag = sin_LUT[sin_index];
    LUT_tri_T cos_mag = cos_LUT[cos_index];

    
    LUT_tri_T sin_cal = sin_mag;
    if (in_phi < 0) sin_cal = -sin_cal;

    LUT_tri_T cos_cal = cos_mag;
    if (in_phi < -360 || in_phi > 360) cos_cal = -cos_cal;

    out_sin = sin_cal;
    out_cos = cos_cal;
}

void Get_xy(Particle_T in_particles, Particle_xy &proj_xy) {
    // This function calculates x, y projection values using LUT
    #pragma HLS pipeline
    
    int sin_index = 0;
    int cos_index = 0;

    const int phi = (int)in_particles.hwPhi;


    if (phi <= -360)      sin_index = phi + 720;
    else if (phi < 0)     sin_index = -phi;
    else if (phi <= 360)  sin_index = phi;
    else                  sin_index = 720 - phi;
    
    if (phi <= -360)      cos_index = phi + 720;
    else if (phi < 0)     cos_index = -phi;
    else if (phi <= 360)  cos_index = phi;
    else                  cos_index = 720 - phi;
    

    static const LUT_tri_T sin_LUT[361] = {
      0, 0.00436331, 0.00872654, 0.0130896, 0.0174524, 0.0218149, 0.0261769, 0.0305385, 0.0348995, 0.0392598, 0.0436194, 0.0479781, 0.052336, 
      0.0566928, 0.0610485, 0.0654031, 0.0697565, 0.0741085, 0.0784591, 0.0828082, 0.0871557, 0.0915016, 0.0958458, 0.100188, 0.104528, 0.108867, 
      0.113203, 0.117537, 0.121869, 0.126199, 0.130526, 0.134851, 0.139173, 0.143493, 0.147809, 0.152123, 0.156434, 0.160743, 0.165048, 0.16935, 
      0.173648, 0.177944, 0.182236, 0.186524, 0.190809, 0.19509, 0.199368, 0.203642, 0.207912, 0.212178, 0.21644, 0.220697, 0.224951, 0.2292, 
      0.233445, 0.237686, 0.241922, 0.246153, 0.25038, 0.254602, 0.258819, 0.263031, 0.267238, 0.27144, 0.275637, 0.279829, 0.284015, 0.288196, 
      0.292372, 0.296542, 0.300706, 0.304864, 0.309017, 0.313164, 0.317305, 0.321439, 0.325568, 0.329691, 0.333807, 0.337917, 0.34202, 0.346117, 
      0.350207, 0.354291, 0.358368, 0.362438, 0.366501, 0.370557, 0.374607, 0.378649, 0.382683, 0.386711, 0.390731, 0.394744, 0.398749, 0.402747, 
      0.406737, 0.410719, 0.414693, 0.41866, 0.422618, 0.426569, 0.430511, 0.434445, 0.438371, 0.442289, 0.446198, 0.450098, 0.45399, 0.457874, 
      0.461749, 0.465615, 0.469472, 0.47332, 0.477159, 0.480989, 0.48481, 0.488621, 0.492424, 0.496217, 0.5, 0.503774, 0.507538, 0.511293, 
      0.515038, 0.518773, 0.522499, 0.526214, 0.529919, 0.533615, 0.5373, 0.540974, 0.544639, 0.548293, 0.551937, 0.55557, 0.559193, 0.562805, 
      0.566406, 0.569997, 0.573576, 0.577145, 0.580703, 0.58425, 0.587785, 0.59131, 0.594823, 0.598325, 0.601815, 0.605294, 0.608761, 0.612217, 
      0.615661, 0.619094, 0.622515, 0.625923, 0.62932, 0.632705, 0.636078, 0.639439, 0.642788, 0.646124, 0.649448, 0.65276, 0.656059, 0.659346, 
      0.66262, 0.665882, 0.669131, 0.672367, 0.67559, 0.678801, 0.681998, 0.685183, 0.688355, 0.691513, 0.694658, 0.69779, 0.700909, 0.704015, 
      0.707107, 0.710185, 0.71325, 0.716302, 0.71934, 0.722364, 0.725374, 0.728371, 0.731354, 0.734323, 0.737277, 0.740218, 0.743145, 0.746057, 
      0.748956, 0.75184, 0.75471, 0.757565, 0.760406, 0.763232, 0.766044, 0.768842, 0.771625, 0.774393, 0.777146, 0.779884, 0.782608, 0.785317, 
      0.788011, 0.79069, 0.793353, 0.796002, 0.798636, 0.801254, 0.803857, 0.806445, 0.809017, 0.811574, 0.814116, 0.816642, 0.819152, 0.821647, 
      0.824126, 0.82659, 0.829038, 0.83147, 0.833886, 0.836286, 0.838671, 0.841039, 0.843391, 0.845728, 0.848048, 0.850352, 0.85264, 0.854912, 
      0.857167, 0.859406, 0.861629, 0.863836, 0.866025, 0.868199, 0.870356, 0.872496, 0.87462, 0.876727, 0.878817, 0.880891, 0.882948, 0.884988, 
      0.887011, 0.889017, 0.891007, 0.892979, 0.894934, 0.896873, 0.898794, 0.900698, 0.902585, 0.904455, 0.906308, 0.908143, 0.909961, 0.911762, 
      0.913545, 0.915311, 0.91706, 0.918791, 0.920505, 0.922201, 0.92388, 0.925541, 0.927184, 0.92881, 0.930418, 0.932008, 0.93358, 0.935135, 
      0.936672, 0.938191, 0.939693, 0.941176, 0.942641, 0.944089, 0.945519, 0.94693, 0.948324, 0.949699, 0.951057, 0.952396, 0.953717, 0.95502, 
      0.956305, 0.957571, 0.95882, 0.96005, 0.961262, 0.962455, 0.96363, 0.964787, 0.965926, 0.967046, 0.968148, 0.969231, 0.970296, 0.971342, 
      0.97237, 0.973379, 0.97437, 0.975342, 0.976296, 0.977231, 0.978148, 0.979045, 0.979925, 0.980785, 0.981627, 0.98245, 0.983255, 0.984041, 
      0.984808, 0.985556, 0.986286, 0.986996, 0.987688, 0.988362, 0.989016, 0.989651, 0.990268, 0.990866, 0.991445, 0.992005, 0.992546, 0.993068, 
      0.993572, 0.994056, 0.994522, 0.994969, 0.995396, 0.995805, 0.996195, 0.996566, 0.996917, 0.99725, 0.997564, 0.997859, 0.998135, 0.998392, 
      0.99863, 0.998848, 0.999048, 0.999229, 0.999391, 0.999534, 0.999657, 0.999762, 0.999848, 0.999914, 0.999962, 0.99999, 1
    };
    
    static const LUT_tri_T cos_LUT[361] = {1, 0.99999, 0.999962, 0.999914, 0.999848, 0.999762, 0.999657, 0.999534, 0.999391, 0.999229, 0.999048, 
      0.998848, 0.99863, 0.998392, 0.998135, 0.997859, 0.997564, 0.99725, 0.996917, 0.996566, 0.996195, 0.995805, 0.995396, 0.994969, 0.994522, 
      0.994056, 0.993572, 0.993068, 0.992546, 0.992005, 0.991445, 0.990866, 0.990268, 0.989651, 0.989016, 0.988362, 0.987688, 0.986996, 0.986286, 
      0.985556, 0.984808, 0.984041, 0.983255, 0.98245, 0.981627, 0.980785, 0.979925, 0.979045, 0.978148, 0.977231, 0.976296, 0.975342, 0.97437, 
      0.973379, 0.97237, 0.971342, 0.970296, 0.969231, 0.968148, 0.967046, 0.965926, 0.964787, 0.96363, 0.962455, 0.961262, 0.96005, 0.95882, 
      0.957571, 0.956305, 0.95502, 0.953717, 0.952396, 0.951057, 0.949699, 0.948324, 0.94693, 0.945519, 0.944089, 0.942641, 0.941176, 0.939693, 
      0.938191, 0.936672, 0.935135, 0.93358, 0.932008, 0.930418, 0.92881, 0.927184, 0.925541, 0.92388, 0.922201, 0.920505, 0.918791, 0.91706, 
      0.915311, 0.913545, 0.911762, 0.909961, 0.908143, 0.906308, 0.904455, 0.902585, 0.900698, 0.898794, 0.896873, 0.894934, 0.892979, 0.891007, 
      0.889017, 0.887011, 0.884988, 0.882948, 0.880891, 0.878817, 0.876727, 0.87462, 0.872496, 0.870356, 0.868199, 0.866025, 0.863836, 0.861629, 
      0.859406, 0.857167, 0.854912, 0.85264, 0.850352, 0.848048, 0.845728, 0.843391, 0.841039, 0.838671, 0.836286, 0.833886, 0.83147, 0.829038, 
      0.82659, 0.824126, 0.821647, 0.819152, 0.816642, 0.814116, 0.811574, 0.809017, 0.806445, 0.803857, 0.801254, 0.798636, 0.796002, 0.793353, 
      0.79069, 0.788011, 0.785317, 0.782608, 0.779884, 0.777146, 0.774393, 0.771625, 0.768842, 0.766044, 0.763232, 0.760406, 0.757565, 0.75471, 
      0.75184, 0.748956, 0.746057, 0.743145, 0.740218, 0.737277, 0.734323, 0.731354, 0.728371, 0.725374, 0.722364, 0.71934, 0.716302, 0.71325, 
      0.710185, 0.707107, 0.704015, 0.700909, 0.69779, 0.694658, 0.691513, 0.688355, 0.685183, 0.681998, 0.678801, 0.67559, 0.672367, 0.669131, 
      0.665882, 0.66262, 0.659346, 0.656059, 0.65276, 0.649448, 0.646124, 0.642788, 0.639439, 0.636078, 0.632705, 0.62932, 0.625923, 0.622515, 
      0.619094, 0.615661, 0.612217, 0.608761, 0.605294, 0.601815, 0.598325, 0.594823, 0.59131, 0.587785, 0.58425, 0.580703, 0.577145, 0.573576, 
      0.569997, 0.566406, 0.562805, 0.559193, 0.55557, 0.551937, 0.548293, 0.544639, 0.540974, 0.5373, 0.533615, 0.529919, 0.526214, 0.522499, 
      0.518773, 0.515038, 0.511293, 0.507538, 0.503774, 0.5, 0.496217, 0.492424, 0.488621, 0.48481, 0.480989, 0.477159, 0.47332, 0.469472, 
      0.465615, 0.461749, 0.457874, 0.45399, 0.450098, 0.446198, 0.442289, 0.438371, 0.434445, 0.430511, 0.426569, 0.422618, 0.41866, 0.414693, 
      0.410719, 0.406737, 0.402747, 0.398749, 0.394744, 0.390731, 0.386711, 0.382683, 0.378649, 0.374607, 0.370557, 0.366501, 0.362438, 0.358368, 
      0.354291, 0.350207, 0.346117, 0.34202, 0.337917, 0.333807, 0.329691, 0.325568, 0.321439, 0.317305, 0.313164, 0.309017, 0.304864, 0.300706, 
      0.296542, 0.292372, 0.288196, 0.284015, 0.279829, 0.275637, 0.27144, 0.267238, 0.263031, 0.258819, 0.254602, 0.25038, 0.246153, 0.241922, 
      0.237686, 0.233445, 0.2292, 0.224951, 0.220697, 0.21644, 0.212178, 0.207912, 0.203642, 0.199368, 0.19509, 0.190809, 0.186524, 0.182236, 
      0.177944, 0.173648, 0.16935, 0.165048, 0.160743, 0.156434, 0.152123, 0.147809, 0.143493, 0.139173, 0.134851, 0.130526, 0.126199, 0.121869, 
      0.117537, 0.113203, 0.108867, 0.104528, 0.100188, 0.0958458, 0.0915016, 0.0871557, 0.0828082, 0.0784591, 0.0741085, 0.0697565, 0.0654031, 
      0.0610485, 0.0566928, 0.052336, 0.0479781, 0.0436194, 0.0392598, 0.0348995, 0.0305385, 0.0261769, 0.0218149, 0.0174524, 0.0130896, 0.00872654, 
      0.00436331, 0
    };

    LUT_tri_T sin_mag = sin_LUT[sin_index];
    LUT_tri_T cos_mag = cos_LUT[cos_index];

    
    LUT_tri_T sin_cal = sin_mag;
    if (phi < 0) sin_cal = -sin_cal;

    LUT_tri_T cos_cal = cos_mag;
    if (phi < -360 || phi > 360) cos_cal = -cos_cal;

    
    proj_xy.hwPx = in_particles.hwPt * cos_cal;
    proj_xy.hwPy = in_particles.hwPt * sin_cal;
}


void Sum_Particles(Particle_xy proj_xy[NPARTICLES], Particle_xy &met_xy) {
  // Sum of maximum 128 vectors in parallel

  #pragma HLS pipeline

  proj_t proj_x[NPARTICLES];
  proj_t proj_y[NPARTICLES];
  proj_t met_x = 0;
  proj_t met_y = 0;

  met_xy.hwPx = 0;
  met_xy.hwPy = 0;

  #pragma HLS ARRAY_PARTITION variable=proj_xy complete
  #pragma HLS ARRAY_PARTITION variable=proj_x complete
  #pragma HLS ARRAY_PARTITION variable=proj_y complete

  for(int i=0; i<NPARTICLES; ++i) {
    #pragma HLS unroll
    proj_x[i] = proj_xy[i].hwPx;
    proj_y[i] = proj_xy[i].hwPy;
  }

  CALC_LOOP:
  for(int i=0; i<NPARTICLES; ++i) {
    #pragma HLS unroll
    // Note: If Proj value has more float bits than metx&y, it makes lots of latency
    met_xy.hwPx -= proj_x[i];
    met_xy.hwPy -= proj_y[i];
  }
}


void puppimet_xy(Particle_T in_particles[NPARTICLES], Particle_xy &met_xy, METCtrlToken token_d, METCtrlToken& token_q) {
  
  #pragma HLS pipeline

  Particle_xy proj_xy[NPARTICLES];

  #pragma HLS ARRAY_PARTITION variable=in_particles complete
  #pragma HLS ARRAY_PARTITION variable=proj_xy complete

  #pragma HLS aggregate variable=in_particles compact=bit
  #pragma HLS aggregate variable=met_xy compact=bit
  #pragma HLS aggregate variable=token_d compact=bit
  #pragma HLS aggregate variable=token_q compact=bit

  #pragma HLS interface ap_none port=in_particles
  #pragma HLS interface ap_none port=met_xy
  #pragma HLS interface ap_none port=token_d
  #pragma HLS interface ap_none port=token_q

  Proj_LOOP:
  for(int i=0; i<NPARTICLES; ++i) {
    #pragma HLS unroll
    Get_xy(in_particles[i], proj_xy[i]);
  }
  
  Sum_Particles(proj_xy, met_xy);
  token_q = token_d;
  return;
}


void pxpy_to_ptphi(const Particle_xy met_xy, Sum &out_met, METCtrlToken token_d, METCtrlToken& token_q) {
  // convert x, y coordinate to pt, phi coordinate using HLS math library
  
  #pragma HLS pipeline
  
  #pragma HLS aggregate variable=met_xy compact=bit
  #pragma HLS aggregate variable=out_met compact=bit
  #pragma HLS aggregate variable=token_d compact=bit
  #pragma HLS aggregate variable=token_q compact=bit

  #pragma HLS interface ap_none port=met_xy
  #pragma HLS interface ap_none port=out_met
  #pragma HLS interface ap_none port=token_d
  #pragma HLS interface ap_none port=token_q

  out_met.clear();
  out_met.hwPt = hls::hypot(met_xy.hwPx, met_xy.hwPy);
  // Reduce Latency by not-using division.
  out_met.hwPhi = phi_t(ap_fixed<26, 11>(hls::atan2(met_xy.hwPy, met_xy.hwPx)) * ap_fixed<26, 11>(229.29936));
  // out_met.hwPhi = l1ct::Scales::makeGlbPhi(hls::atan2(met_xy.hwPy, met_xy.hwPx));
  

  token_q = token_d;

  return;
}